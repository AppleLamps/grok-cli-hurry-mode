#!/bin/bash

# Git hook to auto-publish to npm on push
# To install: ln -sf ../../.githooks/pre-push .git/hooks/pre-push

set -e

echo "🚀 Pre-push hook: Building and publishing..."

# Check if we're on main branch
current_branch=$(git branch --show-current)
if [ "$current_branch" != "main" ]; then
    echo "ℹ️  Not on main branch, skipping publish"
    exit 0
fi

# Check if NPM_TOKEN is set
if [ -z "$NPM_TOKEN" ]; then
    echo "⚠️  NPM_TOKEN not set, skipping publish"
    echo "   Set with: export NPM_TOKEN=your_token"
    exit 0
fi

# Build the project
echo "🔨 Building..."
bun run build || {
    echo "❌ Build failed, but continuing (existing TS errors)"
}

# Version bump (patch by default)
echo "📦 Bumping version..."
npm version patch

# Publish to npm
echo "📤 Publishing to npm..."
npm publish --access public

echo "✅ Published successfully!"